\subsection{Генерирование последовательностей де Брёйна при помощи Z3}
\label{DeBruijnZ3}

Нижеследующий фрагмент вполне эзотерического кода вычисляет количество начальных нулевых бит:
\footnote{\url{https://en.wikipedia.org/wiki/Find_first_set}}:

\begin{lstlisting}
int v[64]=
	{ -1,31, 8,30, -1, 7,-1,-1, 29,-1,26, 6, -1,-1, 2,-1,
	  -1,28,-1,-1, -1,19,25,-1, 5,-1,17,-1, 23,14, 1,-1,
	   9,-1,-1,-1, 27,-1, 3,-1, -1,-1,20,-1, 18,24,15,10,
	  -1,-1, 4,-1, 21,-1,16,11, -1,22,-1,12, 13,-1, 0,-1 };

int LZCNT(uint32_t x)
{
    x |= x >> 1;
    x |= x >> 2;
    x |= x >> 4;
    x |= x >> 8;
    x |= x >> 16;
    x *= 0x4badf0d;
    return v[x >> 26];
}
\end{lstlisting}

(Обычно это делается более простым алгоритмом, но в нем будут условные переходы,
а это плохо для процессоров начиная с RISC. В этом алгоритме условных переходов нет.)

Больше об этом: \url{https://yurichev.com/blog/de_bruijn/}.
Использующаяся здесь магическая константа называется \textit{последовательность де Брёйна},
и я однажды использовал полный перебор для его поиска (один из результатов был \textit{0x4badf0d},
который я здесь использовал).
Но что если нам нужна константа для 64-битных значений?
Полный перебор тут не подойдет.

Если вы уже прочитали об этих последовательностях в моем блоге или других источниках,
вы можете увидеть, что 32-битная константа это число, состоящее из 5-битных частей, идущих внахлест,
и все части должны быть уникальны, т.е., не должны повторяться.

Для 64-битной константы, это будут 6-битные части внахлест.

Найти константу можно при помощи поиска гамильтонова пути в графе де Брёйна.
Но я понял что Z3 тоже может это сделать, и хотя это слишком, но зато подходит для демонстрации.

% TODO translate
\lstinputlisting{SMT/de_bruijn/64.py}

Мы просто перечисляем все 6-битные части идущие внахлест и говорим Z3, что они должны быть уникальными (см \TT{Distinct}).
Вывод:

\lstinputlisting{SMT/de_bruijn/output.txt}

Части внахлест легко видимы.
Так что константа это \textit{0x79c52dd0991abf60}.
Проверим:

% TODO translate
\lstinputlisting{SMT/de_bruijn/64.c}

Работает!

Больше о последовательностях де Брёйна:
\url{https://yurichev.com/blog/de_bruijn/},
\url{https://chessprogramming.wikispaces.com/De+Bruijn+sequence},
\url{https://chessprogramming.wikispaces.com/De+Bruijn+Sequence+Generator}.

